<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Portal | Koyoyo College</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --dark-bg: #0f172a;
            --card-bg: #1e293b;
            --gold: #fbbf24;
            --text-gray: #cbd5e1;
            --success: #10b981;
            --primary-blue: #0066ff;
        }
        body { font-family: 'Outfit', sans-serif; background-color: var(--dark-bg); color: white; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }

        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--gold); padding-bottom: 15px; margin-bottom: 30px; }
        .header h1 { margin: 0; color: var(--gold); }
        .search-box { background: var(--card-bg); border: 1px solid #334155; padding: 12px; border-radius: 8px; width: 250px; color: white; outline: none; }
        .search-box:focus { border-color: var(--gold); }

        /* Student Card */
        .student-card { background: var(--card-bg); border-radius: 12px; margin-bottom: 15px; border: 1px solid #334155; overflow: hidden; }
        .student-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; background: #243049; transition: 0.2s; }
        .student-header:hover { background: #2d3748; }
        .student-info h3 { margin: 0; font-size: 1.1rem; color: white; }
        .student-info small { color: var(--text-gray); }
        
        /* Badges */
        .badge { padding: 4px 10px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }
        .badge-pending { background: rgba(245, 158, 11, 0.2); color: #fbbf24; border: 1px solid #fbbf24; }
        .badge-done { background: rgba(16, 185, 129, 0.2); color: #34d399; border: 1px solid #34d399; }

        /* Results List */
        .results-list { display: none; padding: 0; }
        .quiz-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-top: 1px solid #334155; background: #162035; }
        .btn-mark { background: var(--gold); color: black; border: none; padding: 6px 15px; border-radius: 5px; font-weight: 700; cursor: pointer; text-decoration: none; font-size: 0.85rem; }
        .btn-mark:hover { opacity: 0.9; }

        /* Upload Form */
        .lesson-upload-section { background: var(--card-bg); border-radius: 12px; padding: 30px; margin-top: 40px; border: 1px solid #334155; }
        .lesson-upload-section h2 { color: var(--primary-blue); margin-bottom: 25px; text-align: center; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; }
        .form-group input, .form-group textarea, .form-group select { 
            width: 100%; padding: 12px; border: 1px solid #334155; border-radius: 8px; 
            background: #0f172a; color: white; box-sizing: border-box;
        }
        .btn-upload { 
            background: var(--primary-blue); color: white; border: none; padding: 15px; 
            border-radius: 8px; width: 100%; font-weight: 700; cursor: pointer; font-size: 1.1rem;
        }
        .upload-progress { height: 8px; background: #334155; border-radius: 4px; margin-top: 15px; display: none; overflow: hidden; }
        .upload-progress-bar { height: 100%; background: var(--primary-blue); width: 0%; transition: width 0.3s; }
        .upload-status { margin-top: 10px; text-align: center; font-weight: 600; }
        .success { color: var(--success); }
        .error { color: #f87171; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <h1>Teacher Portal</h1>
            <p style="margin:5px 0 0; color:var(--text-gray)">Manage submissions & lessons</p>
        </div>
        <input type="text" id="search-input" class="search-box" placeholder="Search students...">
    </div>

    <div id="loading" style="text-align:center; color:var(--text-gray);">Loading records...</div>
    <div id="students-container"></div>

    <div class="lesson-upload-section">
        <h2><i class="fas fa-file-upload"></i> Upload New Lesson</h2>
        <form id="lesson-upload-form">
            <div class="form-group">
                <label>Lesson Title</label>
                <input type="text" id="lesson-title" required placeholder="e.g., Fractions 101">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="lesson-description" placeholder="What is this lesson about?"></textarea>
            </div>
            <div class="form-group">
                <label>Subject</label>
                <select id="lesson-subject" required>
                    <option value="">-- Select Subject --</option>
                    <option value="Mathematics">Mathematics</option>
                    <option value="English">English</option>
                    <option value="Science">Science</option>
                    <option value="ICT">ICT</option>
                </select>
            </div>
            <div class="form-group">
                <label>File (PDF or Video)</label>
                <input type="file" id="lesson-file" required>
            </div>
            <button type="submit" class="btn-upload">Publish Lesson</button>
            <div class="upload-progress" id="upload-progress">
                <div class="upload-progress-bar" id="upload-progress-bar"></div>
            </div>
            <div class="upload-status" id="upload-status"></div>
        </form>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, query, orderBy, doc, getDoc, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js';
    import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAj6F5GRKf6-hAk4Y6Ac1dOXEA8vgvLe3Q",
      authDomain: "koyoyocollegeafrica.firebaseapp.com",
      projectId: "koyoyocollegeafrica",
      storageBucket: "koyoyocollegeafrica.firebasestorage.app",
      messagingSenderId: "501491274694",
      appId: "1:501491274694:web:8a9d82e1758b0d46d818c7",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    let currentUserGlobal = null;

    // --- 1. AUTH CHECK ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const userRef = doc(db, 'users', user.uid);
            const userSnap = await getDoc(userRef);
            if (userSnap.exists() && userSnap.data().role === 'teacher') {
                currentUserGlobal = { uid: user.uid, username: userSnap.data().username || user.email };
                loadPortal();
            } else {
                document.getElementById('loading').textContent = "Access Denied: Teachers only.";
                document.getElementById('lesson-upload-form').style.display = 'none';
            }
        } else {
            window.location.href = "login.html";
        }
    });

    // --- 2. LOAD QUIZ RESULTS ---
    async function loadPortal() {
        const container = document.getElementById('students-container');
        const loading = document.getElementById('loading');
        try {
            const q = query(collection(db, "quizResults"), orderBy("timestamp", "desc"));
            const snapshot = await getDocs(q);
            const usersSnapshot = await getDocs(collection(db, "users"));
            
            const userNames = {};
            usersSnapshot.forEach(u => userNames[u.id] = u.data().username || "Unknown");

            const students = {};
            snapshot.forEach(doc => {
                const data = doc.data();
                const uid = data.userId || "Unknown";
                if (!students[uid]) students[uid] = [];
                students[uid].push({ id: doc.id, ...data });
            });

            container.innerHTML = "";
            loading.style.display = 'none';

            for (const [uid, results] of Object.entries(students)) {
                const pendingCount = results.filter(r => r.markingStatus !== "Completed").length;
                const card = document.createElement('div');
                card.className = 'student-card';
                card.innerHTML = `
                    <div class="student-header" onclick="toggleDetails(this)">
                        <div class="student-info">
                            <h3>${userNames[uid] || uid}</h3>
                            <small>${results.length} Quizzes Submitted</small>
                        </div>
                        <span class="badge ${pendingCount > 0 ? 'badge-pending' : 'badge-done'}">
                            ${pendingCount > 0 ? pendingCount + ' Pending' : 'All Graded'}
                        </span>
                    </div>
                    <div class="results-list">
                        ${results.map(r => `
                            <div class="quiz-row">
                                <div>
                                    <div style="font-weight:600">${r.quizId || 'Quiz'}</div>
                                    <small style="color:var(--text-gray)">${r.timestamp?.toDate().toLocaleDateString()}</small>
                                </div>
                                <div style="text-align:right">
                                    <div style="color:var(--gold)">Score: ${r.totalFinalGrade || r.score} / ${r.totalQuestions}</div>
                                    <a href="admin-marking.html?id=${r.id}" class="btn-mark">Mark Quiz</a>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(card);
            }
        } catch (err) {
            loading.textContent = "Error loading submissions.";
            console.error(err);
        }
    }

    // --- 3. UI UTILITIES ---
    window.toggleDetails = (el) => {
        const list = el.nextElementSibling;
        list.style.display = (list.style.display === 'block') ? 'none' : 'block';
    };

    document.getElementById('search-input').addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        document.querySelectorAll('.student-card').forEach(card => {
            card.style.display = card.textContent.toLowerCase().includes(term) ? 'block' : 'none';
        });
    });

    // --- 4. LESSON UPLOAD ---
    const uploadForm = document.getElementById('lesson-upload-form');
    uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const file = document.getElementById('lesson-file').files[0];
        const title = document.getElementById('lesson-title').value;
        const subject = document.getElementById('lesson-subject').value;
        const statusEl = document.getElementById('upload-status');
        const progressBar = document.getElementById('upload-progress-bar');
        const progressContainer = document.getElementById('upload-progress');

        if(!file || !currentUserGlobal) return;

        statusEl.textContent = "Uploading file...";
        statusEl.className = "upload-status";
        progressContainer.style.display = 'block';

        const fileRef = ref(storage, `lessons/${subject}/${Date.now()}_${file.name}`);
        const uploadTask = uploadBytesResumable(fileRef, file);

        uploadTask.on('state_changed', 
            (snapshot) => {
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                progressBar.style.width = progress + '%';
            }, 
            (error) => {
                statusEl.textContent = "Error: " + error.message;
                statusEl.className = "upload-status error";
            }, 
            async () => {
                const url = await getDownloadURL(uploadTask.snapshot.ref);
                await addDoc(collection(db, "lessons"), {
                    title, 
                    subject, 
                    fileUrl: url,
                    description: document.getElementById('lesson-description').value,
                    teacherId: currentUserGlobal.uid,
                    teacherName: currentUserGlobal.username,
                    uploadDate: serverTimestamp()
                });
                statusEl.textContent = "Lesson Published Successfully!";
                statusEl.className = "upload-status success";
                uploadForm.reset();
                setTimeout(() => { progressContainer.style.display = 'none'; }, 3000);
            }
        );
    });
</script>
</body>
</html>
